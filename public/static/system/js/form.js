layui.extend({xmSelect:"xm-select"}).use(["func","upload","jquery","laydate","laytpl","form","colorpicker","slider","rate","transfer","tree","xmSelect"],(function(){var upload=layui.upload,layer=layui.layer,$=layui.jquery,laydate=layui.laydate,laytpl=layui.laytpl,form=layui.form,colorpicker=layui.colorpicker,func=layui.func,slider=layui.slider,transfer=layui.transfer,rate=layui.rate,tree=layui.tree,xmSelect=layui.xmSelect;"undefined"!=typeof formData&&func.assign(formData),function(){if("undefined"!=typeof formTrigger){var ft=formTrigger,fv=form.val("hsForm"),func=function(k,v,c){var t,s=function(k,i){for(var ii in ft[k][i])$("#hs-item-"+ft[k][i][ii]).show()},h=function(k,i){for(var ii in ft[k][i])$("#hs-item-"+ft[k][i][ii]).hide()};if("checkbox"==$(".field-"+k).attr("type")){var fv=form.val("hsForm"),a=[];for(var i in fv)-1!=i.indexOf(k+"[")&&a.push(fv[i]);for(var i in ft[k])-1!=a.indexOf(i)?s(k,i):h(k,i)}else for(var i in ft[k])v==i?s(k,i):h(k,i)};for(var k in ft){var type=$(".field-"+k).attr("type");form.on(type+"("+k+")",(function(data){func($(data.elem).attr("lay-filter"),data.value,data.elem.checked)})),func(k,fv[k])}$("form").show()}}();var uploadObj=function(elem){upload.render({elem:elem||".layui-upload",method:"post",before:function(input){layer.msg("上传中...",{time:3e6})},done:function(res,index,upload){var obj=this.item;if(0==res.code)return layer.msg(res.msg),!1;layer.closeAll();var input=$(obj).siblings(".file-input");input.val(res.data.file),"image"==$(obj).attr("lay-type")?input.siblings(".upload-preview").html('<img src="'+res.data.file+'">'):input.siblings(".upload-preview").html('<a class="layui-badge layui-bg-blue" href="'+res.data.file+'" target="_blank">预览</a>')}})};if(uploadObj(),!$(".layui-form-mid").length&&$(".migu-form .layui-input-inline").css({"min-width":"70%"}),$(".migu-colorpicker").each((function(){var that=$(this),def={elem:"#"+that.attr("id"),color:that.siblings("input").val(),change:function(color){$("#layui-colorpicker-input-"+that.attr("data-name")).val(color)}},opt=func.jsonParse(that.siblings("input").attr("lay-data"));Object.assign(opt,def),colorpicker.render(opt)})),func.inputTag.init(),$(".layui-date").each((function(i){var t=$(this),def={elem:this,type:t.attr("laydata-type"),trigger:"click"},opt=func.jsonParse(t.attr("laydata-options"))||[];Object.assign(opt,def),t.attr("laydata-format")&&(opt.format=t.attr("laydata-format")),laydate.render(opt)})),upload.render({elem:".migu-upload-photo",method:"post",multiple:!0,before:function(input){layer.msg("文件上传中...",{time:3e6})},done:function(res,index,upload){var obj=$(this.item),field=obj.attr("data-field"),len=$(".photo-"+field+"-path").length;if(0==res.code)return layer.msg(res.msg),!1;layer.closeAll(),laytpl($("#J_PhotoTpl").html()).render({index:len,field:field,file:res.data.file,desc:""},(function(html){obj.before(html)}))}}),$(document).on("click",".layui-icon-prev,.layui-icon-next",(function(){var t=$(this),field=t.attr("data-field");if(t.hasClass("layui-icon-prev")){var cur,prev=(cur=t.parent()).prev();prev.length>0&&prev.insertAfter(cur)}else{var cur,next=(cur=t.parent()).next();next.length>0&&next.insertBefore(cur)}$(".photo-"+field+"-path").each((function(i){$(this).attr("name",field+"["+i+"][path]").siblings(".photo-desc-input").attr("name",field+"["+i+"][desc]")}))})),$(document).on("click",".migu-photo-delete",(function(){$(this).parent("li").remove()})),$(document).on("click",".photo-desc-edit",(function(){var t,input=$(this).siblings(".photo-desc-input");layer.prompt({formType:2,value:input.val(),title:"图片描述",area:["350px","100px"]},(function(value,index,elem){input.val(value),layer.close(index)}))})),$(document).on("click",".img-preview",(function(){var src=$(this).attr("src");"/static/system/image/theme.png"!=src&&layer.photos({photos:{status:1,start:0,title:"图片预览",id:1,data:[{alt:"",src:src}]}})})),$(document).on("click",".files-add,.files-del",(function(){var t=$(this),field=t.attr("data-field"),len=$(".files-"+field+"-desc").length;if(t.hasClass("files-del"))return t.parents("ul").children("li").length>1&&t.parents("li").remove(),void $(".files-"+field+"-desc").each((function(i){$(this).attr("name",field+"["+i+"][desc]").siblings(".files-"+field+"-path").attr("name",field+"["+i+"][path]")}));laytpl($("#J_FilesTpl").html()).render({index:len,field:field,file:"",desc:"",laydata:t.siblings(".layui-upload").attr("lay-data")},(function(html){t.parents("ul").append(html),uploadObj("#files-"+field+"-upload-btn"+len)}))})),$(".migu-slider-inline").each((function(){var t=$(this),opt=func.jsonParse(t.attr("lay-data"));opt.elem="#slider-"+t.attr("data-field"),opt.value=t.children("input").val(),opt.change=function(value){var val="object"==typeof value?value.join(","):value;$(this.elem).siblings("input").val(val)},slider.render(opt)})),$(".migu-form-rate").each((function(){var t=$(this),field=t.attr("data-field"),opt=func.jsonParse(t.attr("lay-data"));opt.elem="#rate-"+field,opt.value=t.children("input").val(),opt.choose=function(value){$(this.elem).siblings(".field-"+field).val(value)},rate.render(opt)})),$(".migu-form-transfer").each((function(){var t=$(this),field=t.attr("data-field"),opt=func.jsonParse(t.attr("lay-data"));opt.elem="#transfer-"+field,opt.onchange=function(data,index){var input=$(opt.elem).siblings(".field-"+field),arr=input.val().split(",");if(0==index){if(arr.length>0)for(var i in data)-1==arr.indexOf(""+data[i].value)&&arr.push(data[i].value)}else for(var i in data){var index;-1!=(index=arr.indexOf(""+data[i].value))&&arr.splice(index,1)}input.val(arr.join(","))},transfer.render(opt)})),$(".migu-form-tree").each((function(){var t=$(this),field=t.attr("data-field"),idName="tree-"+field,def={elem:"#"+idName,id:idName,oncheck:function(obj){var checkData=tree.getChecked(idName),tempArr=[],func=function(data){for(var i in data)tempArr.push(data[i].id),data[i].children&&func(data[i].children);return tempArr};$(opt.elem).siblings(".field-"+field).val(func(checkData).join(","))}},opt=func.jsonParse(t.attr("lay-data"));if(opt=Object.assign(def,opt),tree.render(opt),opt.value){var checked=[];for(var i in opt.value)checked.push(parseInt(opt.value[i]));tree.setChecked(opt.id,checked)}})),$(".migu-linkage").each((function(){var t=$(this),field=t.attr("data-field"),opt=func.jsonParse(t.attr("lay-data"));opt.elem="#linkage-"+t.attr("data-field"),func.linkage.init(opt)})),$(".xm-select").each((function(i){var t=$(this),field=t.attr("data-field"),def={el:"#"+t.attr("id"),name:field},opt=func.jsonParse(t.attr("lay-data"));0==i&&(xmSelectArr=[]),opt.name=opt.name?opt.name:field,"undefined"==typeof formData&&(opt.size=opt.size?opt.size:"mini"),xmSelectArr[field]=xmSelect.render(Object.assign(def,opt))})),$(".migu-pwd-toggle-btn").on("click",(function(){var t=$(this);t.hasClass("fa-eye-slash")?t.removeClass("fa-eye-slash").addClass("fa-eye").siblings("input").prop("type","text"):t.removeClass("fa-eye").addClass("fa-eye-slash").siblings("input").prop("type","password")})),"object"==typeof formTable&&""!=formTable){for(var i in formTable)if(void 0!==formTable[i].data){var tpl=$("#"+i+"TableTpl").html(),tr="#hs-table-"+i+" tbody tr";laytpl(tpl).render(formTable[i].data,(function(html){$(tr).before(html),$(tr+" .layui-upload").each((function(){uploadObj($(this))})),$(tr).find("a").attr("data-index",formTable[i].data.length)}))}form.render()}$(".migu-form-add-tr").on("click",(function(){var t=$(this),f=t.attr("data-field"),tpl=$("#"+f+"TableTpl").html(),i=parseInt(t.attr("data-index"));t.attr("data-index",i+1),laytpl(tpl).render({index:i+1},(function(html){t.parents("tr").before(html),form.render(),t.parents("tbody").find(".layui-upload").each((function(){uploadObj($(this))}))}))}))}));