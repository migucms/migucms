layui.define(["layer","laytpl","form"],(function(exports){var $=layui.jquery,layer=layui.layer,laytpl=layui.laytpl,form=layui.form,device=layui.device(),MOD_NAME="treeTable";$.ajax({url:layui.cache.base+"treeTable/treeTable.css",async:!1,success:function(res){$("head").append('<style id="ew-tree-table-css">'+res+"</style>")}});var TreeTable=function(options){var defaultOption={elem:void 0,data:[],cols:[],reqData:void 0,width:void 0,height:void 0,cellMinWidth:100,skin:void 0,size:void 0,even:void 0,style:void 0,getThead:function(){return getThead(this)},getAllChooseBox:function(){return getAllChooseBox(this)},getColgroup:function(){return getColgroup(this)},getTbWidth:function(){return getTbWidth(this)},tree:{},text:{}},treeDefaultOption={idName:"id",pidName:"pid",childName:"children",haveChildName:"haveChild",openName:"open",isPidData:!1,iconIndex:0,arrowType:void 0,onlyIconControl:!1,getIcon:function(d){return getIcon(d,this)}},textDefaultOption={none:'<div style="padding: 18px 0;">暂无数据</div>'};this.options=$.extend(defaultOption,options),this.options.tree=$.extend(treeDefaultOption,options.tree),this.options.text=$.extend(textDefaultOption,options.text);for(var i=0;i<options.cols.length;i++){var colDefaultOption={field:void 0,title:void 0,align:void 0,templet:void 0,toolbar:void 0,width:void 0,minWidth:void 0,type:void 0,style:void 0,class:"",singleLine:!0,fixed:void 0,unresize:!1};this.options.cols[i]=$.extend(colDefaultOption,options.cols[i])}this.init(),this.bindEvents()};function getThead(options){for(var htmlStr="<tr>",i=0;i<options.cols.length;i++){var col=options.cols[i];htmlStr+='<td data-index="'+i+'" ',col.align&&(htmlStr+=' align="'+col.align+'"'),htmlStr+=" >",col.singleLine&&"checkbox"!=col.type&&(htmlStr+='<div class="ew-tree-table-td-single"><i class="layui-icon layui-icon-close ew-tree-tips-c"></i><div class="ew-tree-tips">'),"checkbox"==col.type?htmlStr+=options.getAllChooseBox():htmlStr+=col.title||"",col.unresize||"checkbox"==col.type||"radio"==col.type||"numbers"==col.type||"space"==col.type||(htmlStr+='<span class="ew-tb-resize"></span>'),col.singleLine&&(htmlStr+="</div></div>"),htmlStr+="</td>"}return htmlStr+="</tr>"}function getColgroup(options){for(var htmlStr="<colgroup>",i=0;i<options.cols.length;i++){var col=options.cols[i];htmlStr+="<col ",col.width?htmlStr+='width="'+col.width+'"':"space"==col.type?htmlStr+='width="15"':"numbers"==col.type?htmlStr+='width="40"':"checkbox"!=col.type&&"radio"!=col.type||(htmlStr+='width="48"'),htmlStr+=" />"}return htmlStr+="</colgroup>"}function getTbWidth(options){for(var minWidth=0,setWidth=!0,i=0;i<options.cols.length;i++){var col=options.cols[i];"space"==col.type?minWidth+=15:"numbers"==col.type?minWidth+=40:"checkbox"==col.type||"radio"==col.type?minWidth+=48:!col.width||/\d+%$/.test(col.width)?(setWidth=!1,col.minWidth?minWidth+=col.minWidth:options.cellMinWidth&&(minWidth+=options.cellMinWidth)):minWidth+=col.width}return{minWidth:minWidth,setWidth:setWidth}}function getAllChooseBox(options){var tbFilter,cbAllFilter;return'<input type="checkbox" lay-filter="'+("ew_tb_choose_all_"+$(options.elem).next().attr("lay-filter"))+'" lay-skin="primary" class="ew-tree-table-checkbox"/>'}function getIcon(d,treeOption){return getHaveChild(d,treeOption)?'<i class="ew-tree-icon layui-icon layui-icon-layer"></i>':'<i class="ew-tree-icon layui-icon layui-icon-file"></i>'}function toggleRow($tr){var indent=parseInt($tr.data("indent")),isOpen,hideInd;$tr.hasClass("ew-tree-table-open")?($tr.removeClass("ew-tree-table-open"),$tr.nextAll("tr").each((function(){if(parseInt($(this).data("indent"))<=indent)return!1;$(this).addClass("ew-tree-tb-hide")}))):($tr.addClass("ew-tree-table-open"),$tr.nextAll("tr").each((function(){var ind=parseInt($(this).data("indent"));return!(ind<=indent)&&(null!=hideInd&&ind>hideInd||($(this).removeClass("ew-tree-tb-hide"),void(hideInd=$(this).hasClass("ew-tree-table-open")?void 0:parseInt($(this).data("indent")))))})));updateFixedTbHead($tr.parent().parent().parent().parent().parent())}function updateFixedTbHead($view){var $group=$view.children(".ew-tree-table-group"),$headBox=$group.children(".ew-tree-table-head"),$tbBox=$group.children(".ew-tree-table-box"),sWidth=$tbBox.width()-$tbBox.prop("clientWidth");sWidth>0?$headBox.css("border-right",sWidth+"px solid #f2f2f2"):$headBox.css("border-right","none")}function hideAllTdTips(){var $single=$(".ew-tree-table-td-single");$single.removeClass("ew-tree-tips-open"),$single.removeClass("ew-show-left")}function getHaveChild(d,treeOption){var haveChild=!1;return null!=d[treeOption.haveChildName]?haveChild=1==(haveChild=d[treeOption.haveChildName])||"true"==haveChild:d[treeOption.childName]&&(haveChild=d[treeOption.childName].length>0),haveChild}function addPidField(data,treeOption,parent){for(var i=0;i<data.length;i++)parent&&(data[i][treeOption.pidName]=parent[treeOption.idName]),data[i][treeOption.childName]&&data[i][treeOption.childName].length>0&&addPidField(data[i][treeOption.childName],treeOption,data[i])}function getDataById(data,id,treeOption){for(var i=0;i<data.length;i++){if(data[i][treeOption.idName]==id)return data[i];if(data[i][treeOption.childName]&&data[i][treeOption.childName].length>0){var d=getDataById(data[i][treeOption.childName],id,treeOption);if(null!=d)return d}}}function delDataById(data,id,treeOption){for(var i=0;i<data.length;i++){if(data[i][treeOption.idName]==id)return data.splice(i,1),!0;var rs;if(data[i][treeOption.childName]&&data[i][treeOption.childName].length>0)if(delDataById(data[i][treeOption.childName],id,treeOption))return!0}}function getPids(list,idName,pidName){for(var pids=[],i=0;i<list.length;i++){for(var hasPid=!1,j=0;j<list.length;j++)i!=j&&list[j][idName]==list[i][pidName]&&(hasPid=!0);hasPid||pids.push(list[i][pidName])}return pids}function pidEquals(pId,pIds){if("Array"!=isClass(pIds))return pId==pIds;for(var i=0;i<pIds.length;i++)if(pId==pIds[i])return!0;return!1}function isClass(o){return null===o?"Null":void 0===o?"Undefined":Object.prototype.toString.call(o).slice(8,-1)}function getPageHeight(){return document.documentElement.clientHeight||document.body.clientHeight}function getPageWidth(){return document.documentElement.clientWidth||document.body.clientWidth}TreeTable.prototype.init=function(){var options=this.options,tbFilter=options.elem.substring(1),$elem=$(options.elem);$elem.removeAttr("lay-filter"),$elem.next(".ew-tree-table").remove();var viewHtml='<div class="layui-form ew-tree-table" style="'+(options.style||"")+'">';viewHtml+='      <div class="ew-tree-table-group">',viewHtml+='         <div class="ew-tree-table-head">',viewHtml+='            <table class="layui-table"></table>',viewHtml+='            <div class="ew-tree-table-border bottom"></div>',viewHtml+="         </div>",viewHtml+='         <div class="ew-tree-table-box">',viewHtml+='            <table class="layui-table"></table>',viewHtml+='            <div class="ew-tree-table-loading"><i class="layui-icon layui-anim layui-anim-rotate layui-anim-loop">&#xe63d;</i></div>',viewHtml+='            <div class="ew-tree-table-empty" style="display: none;">'+(options.text.none||"")+"</div>",viewHtml+="         </div>",viewHtml+="      </div>",viewHtml+='      <div class="ew-tree-table-border top"></div><div class="ew-tree-table-border left"></div>',viewHtml+='      <div class="ew-tree-table-border right"></div><div class="ew-tree-table-border bottom"></div>',viewHtml+="   </div>",$elem.after(viewHtml);var components=this.getComponents(),$view=components.$view;$view.attr("lay-filter",tbFilter);var $group=components.$group,$tbBox=components.$tbBox,$table=components.$table,$headTb=components.$headTb,$tbEmpty=components.$tbEmpty,$tbLoading=components.$tbLoading;options.skin&&$table.attr("lay-skin",options.skin),options.size&&$table.attr("lay-size",options.size),options.even&&$table.attr("lay-even",options.even),device.ie&&($view.find(".ew-tree-table-border.bottom").css("height","1px"),$view.find(".ew-tree-table-border.right").css("width","1px")),options.width&&($view.css("width",options.width),$headTb.parent().css("width",options.width),$tbBox.css("width",options.width));var tbWidth=options.getTbWidth();tbWidth.setWidth?($table.css("width",tbWidth.minWidth),$headTb.css("width",tbWidth.minWidth)):($table.css("min-width",tbWidth.minWidth),$headTb.css("min-width",tbWidth.minWidth));var colgroupHtmlStr=options.getColgroup(),headHtmlStr=colgroupHtmlStr+"<thead>"+options.getThead()+"</thead>";if(options.height)if($table.html(colgroupHtmlStr+"<tbody></tbody>"),$headTb.html(headHtmlStr),$table.css("margin-top","-1px"),0==options.height.indexOf("full-")){var h=parseFloat(options.height.substring(5)),cssStr="<style>.ew-tree-table > .ew-tree-table-group > .ew-tree-table-box {";cssStr+="      height: "+(getPageHeight()-h)+"px;",cssStr+="      height: -moz-calc(100vh - "+h+"px);",cssStr+="      height: -webkit-calc(100vh - "+h+"px);",cssStr+="      height: calc(100vh - "+h+"px);",cssStr+="   }</style>",$tbBox.after(cssStr),$tbBox.attr("ew-tree-full",h)}else $tbBox.css("height",options.height);else $table.html(headHtmlStr+"<tbody></tbody>");form.render("checkbox",tbFilter),options.reqData?this.renderBodyAsync():options.data&&options.data.length>0?(options.tree.isPidData?options.data=treeTb.pidToChildren(options.data,options.tree.idName,options.tree.pidName,options.tree.childName):addPidField(options.data,options.tree),$table.children("tbody").html(this.renderBody(options.data)),$tbLoading.hide(),this.renderNumberCol(),form.render(null,tbFilter),this.checkChooseAllCB(),updateFixedTbHead($view)):($tbLoading.hide(),$tbEmpty.show())},TreeTable.prototype.bindEvents=function(){var that=this,options=this.options,components=this.getComponents(),$view=components.$view,$table=components.$table,$tbEmpty=components.$tbEmpty,tbFilter=components.tbFilter,checkboxFilter=components.checkboxFilter,radioFilter=components.radioFilter,cbAllFilter=components.cbAllFilter,$tbody=$table.children("tbody"),commonMember=function(ext){var $tr=$(this);if(!$tr.is("tr")){var $td_tr=$tr.parent("tr[data-id]");$tr=$td_tr.length>0?$td_tr:$tr.parentsUntil("tr[data-id]").last().parent()}var id=$tr.data("id"),data=getDataById(options.data,id,options.tree),obj={tr:$tr,data:data,del:function(){var indent=parseInt(this.tr.data("indent"));this.tr.nextAll("tr").each((function(){if(parseInt($(this).data("indent"))<=indent)return!1;$(this).remove()}));var $parentTr=this.tr.prevAll("tr");this.tr.remove(),delDataById(options.data,id,options.tree),(!options.data||options.data.length<=0)&&$tbEmpty.show(),that.renderNumberCol(),$parentTr.each((function(){var tInd=parseInt($(this).data("indent"));tInd<indent&&(that.checkParentCB($(this)),indent=tInd)})),that.checkChooseAllCB()},update:function(fields){data=$.extend(data,fields);var indent=parseInt(this.tr.data("indent"));that.renderBodyTr(data,indent,void 0,this.tr),form.render(null,tbFilter),that.checkIndeterminateCB(),that.checkChooseAllCB()}};return $.extend(obj,ext)};$tbody.off("click.fold").on("click.fold",".ew-tree-pack",(function(e){layui.stope(e);var $tr=$(this).parentsUntil("tr").last().parent();if(!$tr.hasClass("ew-tree-table-loading")){var haveChild=$tr.data("have-child");if(1==haveChild||"true"==haveChild){var id=$tr.data("id"),isOpen=$tr.hasClass("ew-tree-table-open"),data=getDataById(options.data,id,options.tree);isOpen||data[options.tree.childName]&&!(data[options.tree.childName].length<=0)?toggleRow($tr):that.renderBodyAsync(data,$tr)}}})),$tbody.off("click.tool").on("click.tool","*[lay-event]",(function(e){layui.stope(e);var $this=$(this);layui.event.call(this,MOD_NAME,"tool("+tbFilter+")",commonMember.call(this,{event:$this.attr("lay-event")}))})),form.on("radio("+radioFilter+")",(function(data){var d=getDataById(options.data,data.value,options.tree);that.removeAllChecked(),d.LAY_CHECKED=!0,layui.event.call(this,MOD_NAME,"checkbox("+tbFilter+")",{checked:!0,data:d,type:"one"})})),form.on("checkbox("+checkboxFilter+")",(function(data){var checked=data.elem.checked,$cb=$(data.elem),$layCb=$cb.next(".layui-form-checkbox");!checked&&$layCb.hasClass("ew-form-indeterminate")&&(checked=!0,$cb.prop("checked",checked),$cb.data("indeterminate","false"),$layCb.addClass("layui-form-checked"),$layCb.removeClass("ew-form-indeterminate"));var d=getDataById(options.data,data.value,options.tree);d.LAY_CHECKED=checked;var $tr=$cb.parentsUntil("tr").last().parent();d[options.tree.childName]&&d[options.tree.childName].length>0&&that.checkSubCB($tr,checked);var indent=parseInt($tr.data("indent"));$tr.prevAll("tr").each((function(){var tInd=parseInt($(this).data("indent"));tInd<indent&&(that.checkParentCB($(this)),indent=tInd)})),that.checkChooseAllCB(),layui.event.call(this,MOD_NAME,"checkbox("+tbFilter+")",{checked:checked,data:d,type:"one"})})),form.on("checkbox("+cbAllFilter+")",(function(data){var checked=data.elem.checked,$cb=$(data.elem),$layCb=$cb.next(".layui-form-checkbox");if(!options.data||options.data.length<=0)return $cb.prop("checked",!1),$cb.data("indeterminate","false"),void $layCb.removeClass("layui-form-checked ew-form-indeterminate");!checked&&$layCb.hasClass("ew-form-indeterminate")&&(checked=!0,$cb.prop("checked",checked),$cb.data("indeterminate","false"),$layCb.addClass("layui-form-checked"),$layCb.removeClass("ew-form-indeterminate")),layui.event.call(this,MOD_NAME,"checkbox("+tbFilter+")",{checked:checked,data:void 0,type:"all"}),that.checkSubCB($table.children("tbody"),checked)})),$tbody.off("click.row").on("click.row","tr",(function(){layui.event.call(this,MOD_NAME,"row("+tbFilter+")",commonMember.call(this,{}))})),$tbody.off("dblclick.rowDouble").on("dblclick.rowDouble","tr",(function(){layui.event.call(this,MOD_NAME,"rowDouble("+tbFilter+")",commonMember.call(this,{}))})),$tbody.off("click.cell").on("click.cell","td",(function(e){var $td=$(this),type=$td.data("type");if("checkbox"!=type&&"radio"!=type){var edit=$td.data("edit"),field=$td.data("field");if(edit){if(layui.stope(e),$tbody.find(".ew-tree-table-edit").length>0)return;var index=$td.data("index"),indentSize=$td.children(".ew-tree-table-indent").length,id=$td.parent().data("id"),d=getDataById(options.data,id,options.tree);if("text"==edit||"number"==edit){var $input=$('<input type="'+edit+'" class="layui-input ew-tree-table-edit"/>');$input[0].value=d[field],$td.append($input),$input.focus(),$input.blur((function(){var value=$(this).val(),rs;value!=d[field]?0==layui.event.call(this,MOD_NAME,"edit("+tbFilter+")",commonMember.call(this,{value:value,field:field}))?($(this).addClass("layui-form-danger"),$(this).focus()):(d[field]=value,that.renderBodyTd(d,indentSize,index,$td)):$(this).remove()}))}else console.error("不支持的单元格编辑类型:"+edit)}else{var rs;0==layui.event.call(this,MOD_NAME,"cell("+tbFilter+")",commonMember.call(this,{td:$td,field:field}))&&layui.stope(e)}}else layui.stope(e)})),$tbody.off("dblclick.cellDouble").on("dblclick.cellDouble","td",(function(e){var $td=$(this),type=$td.data("type");if("checkbox"!=type&&"radio"!=type){var edit=$td.data("edit"),field=$td.data("field"),rs;if(edit)layui.stope(e);else 0==layui.event.call(this,MOD_NAME,"cellDouble("+tbFilter+")",commonMember.call(this,{td:$td,field:field}))&&layui.stope(e)}else layui.stope(e)})),components.$tbBox.on("scroll",(function(){var $this=$(this),scrollLeft=$this.scrollLeft(),scrollTop=$this.scrollTop();components.$headTb.parent().scrollLeft(scrollLeft)}))},TreeTable.prototype.getComponents=function(){var $view=$(this.options.elem).next(),$group=$view.children(".ew-tree-table-group"),$tbBox=$group.children(".ew-tree-table-box"),$table=$tbBox.children(".layui-table"),$headTb=$group.children(".ew-tree-table-head").children(".layui-table"),$tbEmpty=$tbBox.children(".ew-tree-table-empty"),$tbLoading=$tbBox.children(".ew-tree-table-loading"),tbFilter=$view.attr("lay-filter"),checkboxFilter,radioFilter,cbAllFilter;return{$view:$view,$group:$group,$tbBox:$tbBox,$table:$table,$headTb:$headTb,$tbEmpty:$tbEmpty,$tbLoading:$tbLoading,tbFilter:tbFilter,checkboxFilter:"ew_tb_checkbox_"+tbFilter,radioFilter:"ew_tb_radio_"+tbFilter,cbAllFilter:"ew_tb_choose_all_"+tbFilter}},TreeTable.prototype.renderBody=function(data,indentSize,isHide){var options,treeOption=this.options.tree;indentSize||(indentSize=0);for(var htmlStr="",i=0;i<data.length;i++){var d=data[i];htmlStr+=this.renderBodyTr(d,indentSize,isHide);var children=d[treeOption.childName];children&&children.length>0&&(htmlStr+=this.renderBody(children,indentSize+1,!d[treeOption.openName]))}return htmlStr},TreeTable.prototype.renderBodyTr=function(d,indentSize,isHide,$tr){var options=this.options,cols=options.cols,treeOption=options.tree;indentSize||(indentSize=0);var htmlStr="",haveChild=getHaveChild(d,treeOption);if($tr)$tr.data("pid",d[treeOption.pidName]||""),$tr.data("have-child",haveChild),$tr.data("indent",indentSize),$tr.removeClass("ew-tree-table-loading");else{var classNames="";haveChild&&d[treeOption.openName]&&(classNames+="ew-tree-table-open"),isHide&&(classNames+="ew-tree-tb-hide"),htmlStr+='<tr class="'+classNames+'" data-id="'+d[treeOption.idName]+'"',htmlStr+=' data-pid="'+(d[treeOption.pidName]||"")+'" data-have-child="'+haveChild+'"',htmlStr+=' data-indent="'+indentSize+'">'}for(var j=0;j<cols.length;j++){var $td;$tr&&($td=$tr.children("td").eq(j)),htmlStr+=this.renderBodyTd(d,indentSize,j,$td)}return htmlStr+="</tr>"},TreeTable.prototype.renderBodyTd=function(d,indentSize,index,$td){var options=this.options,col=options.cols[index],treeOption=options.tree,components=this.getComponents(),checkboxFilter=components.checkboxFilter,radioFilter=components.radioFilter;indentSize||(indentSize=0);var fieldStr="";if("numbers"==col.type)fieldStr+='<span class="ew-tree-table-numbers"></span>',col.singleLine=!1;else if("checkbox"==col.type){var attrStr='name="'+checkboxFilter+'" lay-filter="'+checkboxFilter+'" value="'+d[treeOption.idName]+'"';attrStr+=d.LAY_CHECKED?' checked="checked"':"",fieldStr+='<input type="checkbox" lay-skin="primary" '+attrStr+' class="ew-tree-table-checkbox" />',col.singleLine=!1}else if("radio"==col.type){var attrStr='name="'+radioFilter+'" lay-filter="'+radioFilter+'" value="'+d[treeOption.idName]+'"';attrStr+=d.LAY_CHECKED?' checked="checked"':"",fieldStr+='<input type="radio" '+attrStr+' class="ew-tree-table-radio" />',col.singleLine=!1}else col.templet?"function"==typeof col.templet?fieldStr+=col.templet(d):"string"==typeof col.templet&&laytpl($(col.templet).html()).render(d,(function(html){fieldStr+=html})):col.toolbar?laytpl($(col.toolbar).html()).render(d,(function(html){fieldStr+=html})):col.field&&null!=d[col.field]&&null!=d[col.field]&&(fieldStr+=d[col.field]);var tdStr="";if(index==treeOption.iconIndex){for(var k=0;k<indentSize;k++)tdStr+='<span class="ew-tree-table-indent"></span>';var haveChild;tdStr+='<span class="ew-tree-pack">',tdStr+='<i class="layui-icon ew-tree-table-arrow '+(getHaveChild(d,treeOption)?"":"ew-tree-table-arrow-hide")+" "+(options.tree.arrowType||"")+'"></i>',tdStr+=treeOption.getIcon(d),options.tree.onlyIconControl?(tdStr+="</span>",tdStr+="<span>"+fieldStr+"</span>"):(tdStr+="<span>"+fieldStr+"</span>",tdStr+="</span>")}else tdStr+=fieldStr;$td&&"numbers"!=col.type&&$td.html(tdStr);var htmlStr='<td data-index="'+index+'" ';return col.field&&(htmlStr+=' data-field="'+col.field+'"'),col.edit&&(htmlStr+=' data-edit="'+col.edit+'"'),col.type&&(htmlStr+=' data-type="'+col.type+'"'),col.align&&(htmlStr+=' align="'+col.align+'"'),col.style&&(htmlStr+=' style="'+col.style+'"'),col.class&&(htmlStr+=' class="'+col.class+'"'),htmlStr+=">",col.singleLine?htmlStr+='<div class="ew-tree-table-td-single"><i class="layui-icon layui-icon-close ew-tree-tips-c"></i><div class="ew-tree-tips">'+tdStr+"</div></div>":htmlStr+=tdStr,htmlStr+="</td>"},TreeTable.prototype.renderBodyAsync=function(d,$tr){var that=this,options=this.options,components=this.getComponents(),$tbEmpty=components.$tbEmpty,$tbLoading=components.$tbLoading;$tr?($tr.addClass("ew-tree-table-loading"),$tr.children("td").find(".ew-tree-pack").children(".ew-tree-table-arrow").addClass("layui-anim layui-anim-rotate layui-anim-loop")):(options.data&&options.data.length>0&&$tbLoading.addClass("ew-loading-float"),$tbLoading.show(),$tbEmpty.hide()),options.reqData(d,(function(res){options.tree.isPidData&&(res=treeTb.pidToChildren(res,options.tree.idName,options.tree.pidName,options.tree.childName)),that.renderBodyData(res,d,$tr),$tr?($tr.removeClass("ew-tree-table-loading"),$tr.children("td").find(".ew-tree-pack").children(".ew-tree-table-arrow").removeClass("layui-anim layui-anim-rotate layui-anim-loop")):($tbLoading.hide(),$tbLoading.removeClass("ew-loading-float"),res&&0!=res.length?$tbEmpty.hide():$tbEmpty.show())}))},TreeTable.prototype.renderBodyData=function(data,d,$tr){var that=this,options=this.options,components=this.getComponents(),$view=components.$view,$table=components.$table,tbFilter=components.tbFilter,indent;addPidField(data,options.tree,d),null==d?options.data=data:d[options.tree.childName]=data,$tr&&(indent=parseInt($tr.data("indent"))+1);var htmlStr=this.renderBody(data,indent);$tr?($tr.nextAll("tr").each((function(){if(parseInt($(this).data("indent"))<=indent-1)return!1;$(this).remove()})),$tr.after(htmlStr),$tr.addClass("ew-tree-table-open")):$table.children("tbody").html(htmlStr),form.render(null,tbFilter),this.renderNumberCol(),this.checkIndeterminateCB(),$tr&&(this.checkParentCB($tr),$tr.prevAll("tr").each((function(){var tInd=parseInt($(this).data("indent"));tInd<indent-1&&(that.checkParentCB($(this)),indent=tInd+1)}))),this.checkChooseAllCB(),updateFixedTbHead($view)},TreeTable.prototype.checkSubCB=function($tr,checked){var that=this,components,cbFilter=this.getComponents().checkboxFilter,indent=-1,$trList;$tr.is("tbody")?$trList=$tr.children("tr"):(indent=parseInt($tr.data("indent")),$trList=$tr.nextAll("tr")),$trList.each((function(){if(parseInt($(this).data("indent"))<=indent)return!1;var $cb=$(this).children("td").find('input[name="'+cbFilter+'"]');$cb.prop("checked",checked),checked?($cb.data("indeterminate","false"),$cb.next(".layui-form-checkbox").addClass("layui-form-checked"),$cb.next(".layui-form-checkbox").removeClass("ew-form-indeterminate")):($cb.data("indeterminate","false"),$cb.next(".layui-form-checkbox").removeClass("layui-form-checked ew-form-indeterminate")),that.update($(this).data("id"),{LAY_CHECKED:checked})}))},TreeTable.prototype.checkParentCB=function($tr){var that=this,components,cbFilter=this.getComponents().checkboxFilter,indent=parseInt($tr.data("indent")),ckNum=0,unCkNum=0;$tr.nextAll("tr").each((function(){if(parseInt($(this).data("indent"))<=indent)return!1;var $cb;$(this).children("td").find('input[name="'+cbFilter+'"]').prop("checked")?ckNum++:unCkNum++}));var $cb=$tr.children("td").find('input[name="'+cbFilter+'"]');ckNum>0&&0==unCkNum?($cb.prop("checked",!0),$cb.data("indeterminate","false"),$cb.next(".layui-form-checkbox").addClass("layui-form-checked"),$cb.next(".layui-form-checkbox").removeClass("ew-form-indeterminate"),this.update($tr.data("id"),{LAY_CHECKED:!0})):0==ckNum&&unCkNum>0?($cb.prop("checked",!1),$cb.data("indeterminate","false"),$cb.next(".layui-form-checkbox").removeClass("layui-form-checked ew-form-indeterminate"),this.update($tr.data("id"),{LAY_CHECKED:!1})):ckNum>0&&unCkNum>0&&($cb.prop("checked",!0),$cb.data("indeterminate","true"),$cb.next(".layui-form-checkbox").addClass("layui-form-checked ew-form-indeterminate"),this.update($tr.data("id"),{LAY_CHECKED:!0}))},TreeTable.prototype.checkChooseAllCB=function(){var components=this.getComponents(),cbAllFilter=components.cbAllFilter,cbFilter=components.checkboxFilter,$tbody=components.$table.children("tbody"),ckNum=0,unCkNum=0;$tbody.children("tr").each((function(){var $cb;$(this).children("td").find('input[name="'+cbFilter+'"]').prop("checked")?ckNum++:unCkNum++}));var $cb=$('input[lay-filter="'+cbAllFilter+'"]');ckNum>0&&0==unCkNum?($cb.prop("checked",!0),$cb.data("indeterminate","false"),$cb.next(".layui-form-checkbox").addClass("layui-form-checked"),$cb.next(".layui-form-checkbox").removeClass("ew-form-indeterminate")):0==ckNum&&unCkNum>0||0==ckNum&&0==unCkNum?($cb.prop("checked",!1),$cb.data("indeterminate","false"),$cb.next(".layui-form-checkbox").removeClass("layui-form-checked ew-form-indeterminate")):ckNum>0&&unCkNum>0&&($cb.prop("checked",!0),$cb.data("indeterminate","true"),$cb.next(".layui-form-checkbox").addClass("layui-form-checked ew-form-indeterminate"))},TreeTable.prototype.renderNumberCol=function(){var components,$tbody;this.getComponents().$table.children("tbody").children("tr").each((function(index){$(this).children("td").find(".ew-tree-table-numbers").text(index+1)}))},TreeTable.prototype.checkIndeterminateCB=function(){var components,cbFilter=this.getComponents().checkboxFilter;$('input[lay-filter="'+cbFilter+'"]').each((function(){var $cb=$(this);"true"==$cb.data("indeterminate")&&$cb.prop("checked")&&$cb.next(".layui-form-checkbox").addClass("ew-form-indeterminate")}))},TreeTable.prototype.filterData=function(ids){var components,$trList=this.getComponents().$table.children("tbody").children("tr");if("string"==typeof ids){var keyword=ids;ids=[],$trList.each((function(){var id=$(this).data("id");$(this).children("td").each((function(){if(-1!=$(this).text().indexOf(keyword))return ids.push(id),!1}))}))}$trList.addClass("ew-tree-table-filter-hide");for(var i=0;i<ids.length;i++){var $tr=$trList.filter('[data-id="'+ids[i]+'"]');$tr.removeClass("ew-tree-table-filter-hide");var indent=parseInt($tr.data("indent"));$tr.prevAll("tr").each((function(){var tInd=parseInt($(this).data("indent"));tInd<indent&&($(this).removeClass("ew-tree-table-filter-hide"),$(this).hasClass("ew-tree-table-open")||toggleRow($(this)),indent=tInd)}))}},TreeTable.prototype.clearFilter=function(){var components,$trList;this.getComponents().$table.children("tbody").children("tr").removeClass("ew-tree-table-filter-hide")},TreeTable.prototype.expand=function(id,cascade){var components,$tr=this.getComponents().$table.children("tbody").children('tr[data-id="'+id+'"]');if($tr.hasClass("ew-tree-table-open")||$tr.children("td").find(".ew-tree-pack").trigger("click"),0!=cascade){var indent=parseInt($tr.data("indent"));$tr.prevAll("tr").each((function(){var tInd=parseInt($(this).data("indent"));tInd<indent&&($(this).hasClass("ew-tree-table-open")||$(this).children("td").find(".ew-tree-pack").trigger("click"),indent=tInd)}))}},TreeTable.prototype.fold=function(id,cascade){var components,$tr=this.getComponents().$table.children("tbody").children('tr[data-id="'+id+'"]');if($tr.hasClass("ew-tree-table-open")&&$tr.children("td").find(".ew-tree-pack").trigger("click"),0!=cascade){var indent=parseInt($tr.data("indent"));$tr.prevAll("tr").each((function(){var tInd=parseInt($(this).data("indent"));tInd<indent&&($(this).hasClass("ew-tree-table-open")&&$(this).children("td").find(".ew-tree-pack").trigger("click"),indent=tInd)}))}},TreeTable.prototype.expandAll=function(){var that=this,components,$trList;this.getComponents().$table.children("tbody").children("tr").each((function(){that.expand($(this).data("id"),!1)}))},TreeTable.prototype.foldAll=function(){var that=this,components,$trList;this.getComponents().$table.children("tbody").children("tr").each((function(){that.fold($(this).data("id"),!1)}))},TreeTable.prototype.getData=function(){return this.options.data},TreeTable.prototype.reload=function(opt){treeTb.render($.extend(this.options,opt))},TreeTable.prototype.update=function(id,fields){var data=getDataById(this.getData(),id,this.options.tree);$.extend(data,fields)},TreeTable.prototype.del=function(id){delDataById(this.getData(),id,this.options.tree)},TreeTable.prototype.checkStatus=function(needIndeterminate){null==needIndeterminate&&(needIndeterminate=!0);var that=this,components=this.getComponents(),$table=components.$table,checkboxFilter=components.checkboxFilter,radioFilter=components.radioFilter,list=[],$radio=$table.find('input[name="'+radioFilter+'"]');if($radio.length>0){var id=$radio.filter(":checked").val(),d=getDataById(this.getData(),id,this.options.tree);d&&list.push(d)}else $table.find('input[name="'+checkboxFilter+'"]:checked').each((function(){var id=$(this).val(),isIndeterminate=$(this).next(".layui-form-checkbox").hasClass("ew-form-indeterminate");if(needIndeterminate||!isIndeterminate){var d=getDataById(that.getData(),id,that.options.tree);d&&(d.isIndeterminate=isIndeterminate,list.push(d))}}));return list},TreeTable.prototype.setChecked=function(ids){var components=this.getComponents(),$table=components.$table,checkboxFilter=components.checkboxFilter,radioFilter=components.radioFilter,$radio=$table.find('input[name="'+radioFilter+'"]');$radio.length>0?$radio.each((function(){if(ids[ids.length-1]==$(this).val())return $(this).next(".layui-form-radio").trigger("click"),!1})):$table.find('input[name="'+checkboxFilter+'"]').each((function(){for(var $cb=$(this),value=$cb.val(),$layCb=$cb.next(".layui-form-checkbox"),i=0;i<ids.length;i++)if(value==ids[i]){var checked=$cb.prop("checked"),indeterminate=$layCb.hasClass("ew-form-indeterminate");checked&&!indeterminate||$layCb.trigger("click")}}))},TreeTable.prototype.removeAllChecked=function(){var components=this.getComponents(),$table=components.$table,checkboxFilter=components.checkboxFilter;this.checkSubCB($table.children("tbody"),!1)},TreeTable.prototype.refresh=function(id,data){"Array"==isClass(id)&&(data=id,id=void 0);var components=this.getComponents(),$table=components.$table,d,$tr;null!=id&&(d=getDataById(this.getData(),id,this.options.tree),$tr=$table.children("tbody").children('tr[data-id="'+id+'"]')),data?(components.$tbLoading.addClass("ew-loading-float"),components.$tbLoading.show(),this.renderBodyData(data,d,$tr),components.$tbLoading.hide(),components.$tbLoading.removeClass("ew-loading-float"),data&&data.length>0?components.$tbEmpty.hide():components.$tbEmpty.show()):this.renderBodyAsync(d,$tr)},$(window).resize((function(){$(".ew-tree-table").each((function(){updateFixedTbHead($(this));var $tbBox=$(this).children(".ew-tree-table-group").children(".ew-tree-table-box"),full=$tbBox.attr("ew-tree-full");full&&device.ie&&device.ie<10&&$tbBox.css("height",getPageHeight()-full)}))})),$(document).on("mouseenter",".ew-tree-table td",(function(){var $tdSingle=$(this).children(".ew-tree-table-td-single"),$content=$tdSingle.children(".ew-tree-tips");$tdSingle.length>0&&$content.prop("scrollWidth")>$content.outerWidth()&&$(this).append('<div class="layui-table-grid-down"><i class="layui-icon layui-icon-down"></i></div>')})).on("mouseleave",".ew-tree-table td",(function(){$(this).children(".layui-table-grid-down").remove()})),$(document).on("click",".ew-tree-table td>.layui-table-grid-down",(function(e){hideAllTdTips();var $tdSingle=$(this).parent().children(".ew-tree-table-td-single");$tdSingle.addClass("ew-tree-tips-open");var $box=$tdSingle.parents().filter(".ew-tree-table-box");$box.length<=0&&($box=$tdSingle.parents().filter(".ew-tree-table-head")),$tdSingle.outerWidth()+$tdSingle.parent().offset().left>$box.offset().left+$box.outerWidth()&&$tdSingle.addClass("ew-show-left"),$tdSingle.outerHeight()+$tdSingle.parent().offset().top>$box.offset().top+$box.outerHeight()&&$tdSingle.addClass("ew-show-bottom"),e.stopPropagation()})),$(document).on("click",".ew-tree-table .ew-tree-tips-c",(function(e){hideAllTdTips()})),$(document).on("click",(function(){hideAllTdTips()})),$(document).on("click",".ew-tree-table-td-single.ew-tree-tips-open",(function(e){e.stopPropagation()}));var treeTb={render:function(options){return new TreeTable(options)},on:function(events,callback){return layui.onevent.call(this,MOD_NAME,events,callback)},pidToChildren:function(data,idName,pidName,childName,pId){childName||(childName="children");for(var newList=[],i=0;i<data.length;i++)if(null==pId&&(pId=getPids(data,idName,pidName)),pidEquals(data[i][pidName],pId)){var children=this.pidToChildren(data,idName,pidName,childName,data[i][idName]);children.length>0&&(data[i][childName]=children),newList.push(data[i])}return newList}};exports("treeTable",treeTb)}))